<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Python
"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">    <!--
      .comment {
        /* font-lock-comment-face */
        color: #bebebe;
      }
      .comment-delimiter {
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #b2dfee;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #ffa500;
      }
      .py-builtins {
        /* py-builtins-face */
        color: #ffa500;
      }
      .py-pseudo-keyword {
        /* py-pseudo-keyword-face */
        color: #ffa500;
      }
      .string {
        /* font-lock-string-face */
        color: #00cd00;
      }
      .type {
        /* font-lock-type-face */
        color: #98fb98;
      }
    -->
    </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Python
</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">Introduction
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">There is no standard cgi/web framework in python,
</span><span class="comment-delimiter"># </span><span class="comment">this is reason for ranting now and then.
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">See `PyWebOff &lt;<a href="http://pyre.third-bit.com/pyweb/index.html">http://pyre.third-bit.com/pyweb/index.html</a>&gt;`__
</span><span class="comment-delimiter"># </span><span class="comment">which compares CherryPy, Quixote, Twisted, WebWare and Zope
</span><span class="comment-delimiter"># </span><span class="comment">Karrigell and print stantements. 
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">Then there is Nevow and Standalone ZPT.
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">Partial implementation of PLEAC Python section 19.1
</span><span class="comment-delimiter"># </span><span class="comment">Written by Seo Sanghyeon
</span>
<span class="comment-delimiter"># </span><span class="comment">Standard CGI module is where PERL shines. Python
</span><span class="comment-delimiter"># </span><span class="comment">module, cgi, is nothing but a form parser. So it is
</span><span class="comment-delimiter"># </span><span class="comment">not really fair to compare these two. But I hesitate
</span><span class="comment-delimiter"># </span><span class="comment">to introduce any non-standard module. After all,
</span><span class="comment-delimiter"># </span><span class="comment">which one should I choose?
</span>
<span class="comment-delimiter"># </span><span class="comment">I would stick to simple print statements. I believe
</span><span class="comment-delimiter"># </span><span class="comment">the following is close to how these tasks are usually
</span><span class="comment-delimiter"># </span><span class="comment">done in Python.
</span>
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter">#</span><span class="comment">!/usr/bin/env python
</span><span class="comment-delimiter"># </span><span class="comment">hiweb - using FieldStorage class to get at form data
</span>
<span class="keyword">import</span> cgi
form = cgi.FieldStorage()

<span class="comment-delimiter"># </span><span class="comment">get a value from the form
</span>value = form.getvalue(<span class="string">"PARAM_NAME"</span>)

<span class="comment-delimiter"># </span><span class="comment">print a standard header
</span><span class="keyword">print</span> <span class="string">"Content-Type: text/html"</span>
<span class="keyword">print</span>

<span class="comment-delimiter"># </span><span class="comment">print a document
</span><span class="keyword">print</span> <span class="string">"&lt;P&gt;You typed: &lt;TT&gt;%s&lt;/TT&gt;&lt;/P&gt;"</span> % (
    cgi.escape(value),
    )

<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="keyword">import</span> cgi
form = cgi.FieldStorage()

who = form.getvalue(<span class="string">"Name"</span>)
phone = form.getvalue(<span class="string">"Number"</span>)
picks = form.getvalue(<span class="string">"Choices"</span>)

<span class="comment-delimiter"># </span><span class="comment">if you want to assure `picks' to be a list
</span>picks = form.getlist(<span class="string">"Choices"</span>)

<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">Not Implemented
</span>
<span class="comment-delimiter"># </span><span class="comment">To implement -EXPIRES =&gt; '+3d', I need to study about
</span><span class="keyword">import</span> cgi
<span class="keyword">import</span> datetime

time_format = <span class="string">"%a, %d %b %Y %H:%M:%S %Z"</span>
<span class="keyword">print</span> <span class="string">"Expires: %s"</span> % (
        (datetime.datetime.now()
        + datetime.timedelta(+3)).strftime(time_format)
        )
<span class="keyword">print</span> <span class="string">"Date: %s"</span> % (datetime.datetime.now().strftime(time_format))
<span class="keyword">print</span> <span class="string">"Content-Type: text/plain; charset=ISO-8859-1"</span>

<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">NOTES
</span>
<span class="comment-delimiter"># </span><span class="comment">CGI::param() is a multi-purpose function. Here I want to
</span><span class="comment-delimiter"># </span><span class="comment">note which Python functions correspond to it.
</span>
<span class="comment-delimiter"># </span><span class="comment">PERL version 5.6.1, CGI.pm version 2.80.
</span><span class="comment-delimiter"># </span><span class="comment">Python version 2.2.3. cgi.py CVS revision 1.68.
</span>
<span class="comment-delimiter"># </span><span class="comment">Assume that `form' is the FieldStorage instance.
</span>
<span class="comment-delimiter"># </span><span class="comment">param() with zero argument returns parameter names as
</span><span class="comment-delimiter"># </span><span class="comment">a list. It is `form.keys()' in Python, following Python's
</span><span class="comment-delimiter"># </span><span class="comment">usual mapping interface.
</span>
<span class="comment-delimiter"># </span><span class="comment">param() with one argument returns the value of the named
</span><span class="comment-delimiter"># </span><span class="comment">parameter. It is `form.getvalue()', but there are some
</span><span class="comment-delimiter"># </span><span class="comment">twists:
</span>
<span class="comment-delimiter"># </span><span class="comment">1) A single value is passed.
</span><span class="comment-delimiter"># </span><span class="comment">No problem.
</span>
<span class="comment-delimiter"># </span><span class="comment">2) Multiple values are passed.
</span><span class="comment-delimiter"># </span><span class="comment">PERL: in LIST context, you get a list. in SCALAR context,
</span><span class="comment-delimiter">#       </span><span class="comment">you get the first value from the list.
</span><span class="comment-delimiter"># </span><span class="comment">Python: `form.getvalue()' returns a list if multiple
</span><span class="comment-delimiter">#         </span><span class="comment">values are passed, a raw value if a single value
</span><span class="comment-delimiter">#         </span><span class="comment">is passed. With `form.getlist()', you always
</span><span class="comment-delimiter">#         </span><span class="comment">get a list. (When a single value is passed, you
</span><span class="comment-delimiter">#         </span><span class="comment">get a list with one element.) With `form.getfirst()',
</span><span class="comment-delimiter">#         </span><span class="comment">you always get a value. (When multiple values are
</span><span class="comment-delimiter">#         </span><span class="comment">passed, you get the first one.)
</span>
<span class="comment-delimiter"># </span><span class="comment">3) Parameter name is given, but no value is passed.
</span><span class="comment-delimiter"># </span><span class="comment">PERL: returns an empty string, not undef. POD says this
</span><span class="comment-delimiter">#       </span><span class="comment">feature is new in 2.63, and was introduced to avoid
</span><span class="comment-delimiter">#       </span><span class="comment">"undefined value" warnings when running with the
</span><span class="comment-delimiter">#       </span><span class="comment">-w switch.
</span><span class="comment-delimiter"># </span><span class="comment">Python: tricky. If you want black values to be retained,
</span><span class="comment-delimiter">#         </span><span class="comment">you should pass a nonzero `keep_blank_values' keyword
</span><span class="comment-delimiter">#         </span><span class="comment">argument. Default is not to retain blanks. In case
</span><span class="comment-delimiter">#         </span><span class="comment">values are not retained, see below.
</span>
<span class="comment-delimiter"># </span><span class="comment">4) Even parameter name is never mentioned.
</span><span class="comment-delimiter"># </span><span class="comment">PERL: returns undef.
</span><span class="comment-delimiter"># </span><span class="comment">Python: returns None, or whatever you passed as the second
</span><span class="comment-delimiter">#         </span><span class="comment">argument, or `default` keyword argument. This is
</span><span class="comment-delimiter">#         </span><span class="comment">consistent with `get()' method of the Python mapping
</span><span class="comment-delimiter">#         </span><span class="comment">interface.
</span>
<span class="comment-delimiter"># </span><span class="comment">param() with more than one argument modifies the already
</span><span class="comment-delimiter"># </span><span class="comment">set form data. This functionality is not available in Python
</span><span class="comment-delimiter"># </span><span class="comment">cgi module.
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">enable() from 'cgitb' module, by default, redirects traceback
</span><span class="comment-delimiter"># </span><span class="comment">to the browser. It is defined as 'enable(display=True, logdir=None,
</span><span class="comment-delimiter"># </span><span class="comment">context=5)'.
</span>
<span class="comment-delimiter"># </span><span class="comment">equivalent to importing CGI::Carp::fatalsToBrowser.
</span><span class="keyword">import</span> cgitb
cgitb.enable()

<span class="comment-delimiter"># </span><span class="comment">to suppress browser output, you should explicitly say so.
</span><span class="keyword">import</span> cgitb
cgitb.enable(display=<span class="py-pseudo-keyword">False</span>)

<span class="comment-delimiter"># </span><span class="comment">equivalent to call CGI::Carp::carpout with temporary files.
</span><span class="keyword">import</span> cgitb
cgitb.enable(logdir=<span class="string">"/var/local/cgi-logs/"</span>)

<span class="comment-delimiter"># </span><span class="comment">Python exception, traceback facilities are much richer than PERL's
</span><span class="comment-delimiter"># </span><span class="comment">die and its friends. You can use your custom exception formatter
</span><span class="comment-delimiter"># </span><span class="comment">by replacing sys.excepthook. (equivalent to CGI::Carp::set_message.)
</span><span class="comment-delimiter"># </span><span class="comment">Default formatter is available as traceback.print_exc() in pure
</span><span class="comment-delimiter"># </span><span class="comment">Python. In fact, what cgitb.enable() does is replacing excepthook
</span><span class="comment-delimiter"># </span><span class="comment">to cgitb.handler(), which knows how to format exceptions to HTML.
</span>
<span class="comment-delimiter"># </span><span class="comment">If this is not enough, (usually this is enough!) Python 2.3 comes
</span><span class="comment-delimiter"># </span><span class="comment">with a new standard module called 'logging', which is complex, but
</span><span class="comment-delimiter"># </span><span class="comment">very flexible and entirely customizable.
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment"><font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/webwhoami">download the following standalone program</a></font>
</span><span class="comment-delimiter">#</span><span class="comment">!/usr/bin/python
</span><span class="comment-delimiter"># </span><span class="comment">webwhoami - show web users id
</span><span class="keyword">import</span> getpass
<span class="keyword">print</span> <span class="string">"Content-Type: text/plain\n"</span>
<span class="keyword">print</span> <span class="string">"Running as %s\n"</span> % getpass.getuser()



<span class="comment-delimiter"># </span><span class="comment">STDOUT/ERR flushing
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">In contrast to what the perl cookbook says, modpython.org tells
</span><span class="comment-delimiter"># </span><span class="comment">STDERR is buffered too.
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span>
<span class="comment-delimiter"># </span><span class="comment">use mod_python in the Apache web server.
</span>
<span class="comment-delimiter"># </span><span class="comment">Load the module in httpd.conf or apache.conf
</span>
LoadModule python_module libexec/mod_python.so

&lt;Directory /some/directory/htdocs/test&gt;
    AddHandler mod_python .py
    PythonHandler mptest
    PythonDebug On
&lt;/Directory&gt;

<span class="comment-delimiter"># </span><span class="comment">test.py file in /some/directory/htdocs/test
</span><span class="keyword">from</span> mod_python <span class="keyword">import</span> apache

<span class="keyword">def</span> <span class="function-name">handler</span>(req):
    req.write(<span class="string">"Hello World!"</span>)
    <span class="keyword">return</span> apache.OK</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span>
<span class="keyword">import</span> os
os.system(<span class="string">"command %s %s"</span> % (input, <span class="string">" "</span>.join(files))) <span class="comment-delimiter"># </span><span class="comment">UNSAFE
</span>
<span class="comment-delimiter"># </span><span class="comment">python doc lib cgi-security it says
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">To be on the safe side, if you must pass a string gotten from a form to a shell
</span><span class="comment-delimiter"># </span><span class="comment">command, you should make sure the string contains only alphanumeric characters, dashes,
</span><span class="comment-delimiter"># </span><span class="comment">underscores, and periods.
</span><span class="keyword">import</span> re
cmd = <span class="string">"command %s %s"</span> % (input, <span class="string">" "</span>.join(files))
<span class="keyword">if</span> re.search(r<span class="string">"[^a-zA-Z0-9._\-]"</span>, cmd):
    <span class="keyword">print</span> <span class="string">"rejected"</span>
    sys.exit(1)
os.system(cmd)
trans = string.maketrans(string.ascii_letters+string.digits+<span class="string">"-_."</span>,

<span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">This uses nevow's (http://nevow.com) stan; there's no standard
</span><span class="comment-delimiter"># </span><span class="comment">way to generate HTML, though there are many implementations of
</span><span class="comment-delimiter"># </span><span class="comment">this basic idea.
</span><span class="keyword">from</span> nevow <span class="keyword">import</span> tags <span class="keyword">as</span> T
<span class="keyword">print</span> T.ol[T.li[<span class="string">'red'</span>], T.li[<span class="string">'blue'</span>], T.li[<span class="string">'green'</span>]]
<span class="comment-delimiter"># </span><span class="comment">&lt;ol&gt;&lt;li&gt;red&lt;/li&gt;&lt;li&gt;blue&lt;/li&gt;&lt;li&gt;green&lt;/li&gt;&lt;/ol&gt;
</span>
names = <span class="string">'Larry Moe Curly'</span>.split()
<span class="keyword">print</span> T.ul[ [T.li(type=<span class="string">"disc"</span>)[name] <span class="keyword">for</span> name <span class="keyword">in</span> names] ]
<span class="comment-delimiter"># </span><span class="comment">&lt;ul&gt;&lt;li type="disc"&gt;Larry&lt;/li&gt;&lt;li type="disc"&gt;Moe&lt;/li&gt;
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;li type="disc"&gt;Curly&lt;/li&gt;&lt;/ul&gt;
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="keyword">print</span> T.li[<span class="string">"alpha"</span>]
<span class="comment-delimiter">#     </span><span class="comment">&lt;li&gt;alpha&lt;/li&gt;
</span>
<span class="keyword">print</span> T.li[<span class="string">'alpha'</span>], T.li[<span class="string">'omega'</span>]
<span class="comment-delimiter">#     </span><span class="comment">&lt;li&gt;alpha&lt;/li&gt; &lt;li&gt;omega&lt;/li&gt;
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span>states = {
    <span class="string">"Wisconsin"</span>:  [ <span class="string">"Superior"</span>, <span class="string">"Lake Geneva"</span>, <span class="string">"Madison"</span> ],
    <span class="string">"Colorado"</span>:   [ <span class="string">"Denver"</span>, <span class="string">"Fort Collins"</span>, <span class="string">"Boulder"</span> ],
    <span class="string">"Texas"</span>:      [ <span class="string">"Plano"</span>, <span class="string">"Austin"</span>, <span class="string">"Fort Stockton"</span> ],
    <span class="string">"California"</span>: [ <span class="string">"Sebastopol"</span>, <span class="string">"Santa Rosa"</span>, <span class="string">"Berkeley"</span> ],
}

<span class="keyword">print</span> <span class="string">"&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;"</span>;
<span class="keyword">print</span> T.tr[T.th(<span class="string">'State'</span>), T.th(<span class="string">'Cities'</span>)]
<span class="keyword">for</span> k <span class="keyword">in</span> sorted(states.keys()):
    <span class="keyword">print</span> T.tr[ [T.th(k)] + [T.td(city) <span class="keyword">for</span> city <span class="keyword">in</span> sorted(states[k])] ]
<span class="keyword">print</span> <span class="string">"&lt;/TABLE&gt;"</span>;
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;TR&gt;&lt;TH&gt;State&lt;/TH&gt; &lt;TH&gt;Cities&lt;/TH&gt;&lt;/TR&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;TR&gt;&lt;TH&gt;California&lt;/TH&gt; &lt;TD&gt;Berkeley&lt;/TD&gt; &lt;TD&gt;Santa Rosa&lt;/TD&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#         </span><span class="comment">&lt;TD&gt;Sebastopol&lt;/TD&gt; &lt;/TR&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;TR&gt;&lt;TH&gt;Colorado&lt;/TH&gt; &lt;TD&gt;Boulder&lt;/TD&gt; &lt;TD&gt;Denver&lt;/TD&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#         </span><span class="comment">&lt;TD&gt;Fort Collins&lt;/TD&gt; &lt;/TR&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;TR&gt;&lt;TH&gt;Texas&lt;/TH&gt; &lt;TD&gt;Austin&lt;/TD&gt; &lt;TD&gt;Fort Stockton&lt;/TD&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#         </span><span class="comment">&lt;TD&gt;Plano&lt;/TD&gt;&lt;/TR&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#     </span><span class="comment">&lt;TR&gt;&lt;TH&gt;Wisconsin&lt;/TH&gt; &lt;TD&gt;Lake Geneva&lt;/TD&gt; &lt;TD&gt;Madison&lt;/TD&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter">#         </span><span class="comment">&lt;TD&gt;Superior&lt;/TD&gt;&lt;/TR&gt;
</span><span class="comment-delimiter">#</span><span class="comment">
</span><span class="comment-delimiter"># </span><span class="comment">&lt;/TABLE&gt;
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="keyword">print</span> T.table[
        [T.caption[<span class="string">'Cities I have Known'</span>],
         T.tr[T.th[<span class="string">'State'</span>], T.th[<span class="string">'Cities'</span>]] ] +
        [T.tr[ [T.th(k)] + [T.td(city) <span class="keyword">for</span> city <span class="keyword">in</span> sorted(states[k])]]
         <span class="keyword">for</span> k <span class="keyword">in</span> sorted(states.keys())]]
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">salcheck - check for salaries
</span><span class="keyword">import</span> MySQLdb
<span class="keyword">import</span> cgi

form = cgi.FieldStorage()

<span class="keyword">if</span> <span class="string">'limit'</span> <span class="keyword">in</span> form:
    limit = <span class="py-builtins">int</span>(form[<span class="string">'limit'</span>].value)
<span class="keyword">else:</span>
    limit = <span class="string">''</span>

<span class="comment-delimiter"># </span><span class="comment">There's not a good way to start an HTML/XML construct with stan
</span><span class="comment-delimiter"># </span><span class="comment">without completing it.
</span><span class="keyword">print</span> <span class="string">'&lt;html&gt;&lt;head&gt;&lt;title&gt;Salary Query&lt;/title&gt;&lt;/head&gt;&lt;body&gt;'</span>
<span class="keyword">print</span> T.h1[<span class="string">'Search'</span>]
<span class="keyword">print</span> <span class="string">'&lt;form&gt;'</span>
<span class="keyword">print</span> T.p[<span class="string">'Enter minimum salary'</span>,
          T.input(type=<span class="string">"text"</span>, name=<span class="string">"limit"</span>, value=limit)]
<span class="keyword">print</span> T.input(type=<span class="string">"submit"</span>)
<span class="keyword">print</span> <span class="string">'&lt;/form&gt;'</span>

<span class="keyword">if</span> limit:
    dbconn = MySQLdb.connect(db=<span class="string">'somedb'</span>, host=<span class="string">'server.host.dom'</span>,
                             port=3306, user=<span class="string">'username'</span>,
                             passwd=<span class="string">'password'</span>)
    cursor = dbconn.cursor()
    cursor.execute(<span class="string">"""
    SELECT name, salary FROM employees
    WHERE salary &gt; %s"""</span>, (limit,))

    <span class="keyword">print</span> T.h1[<span class="string">"Results"</span>]
    <span class="keyword">print</span> <span class="string">"&lt;TABLE BORDER=1&gt;"</span>

    <span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall():
        <span class="keyword">print</span> T.tr[ [T.td(cell) <span class="keyword">for</span> cell <span class="keyword">in</span> row] ]

    <span class="keyword">print</span> <span class="string">"&lt;/TABLE&gt;\n"</span>;
    cursor.close()
    dbconn.close()

<span class="keyword">print</span> <span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span>url = <span class="string">"http://python.org/pypi"</span>
<span class="keyword">print</span> <span class="string">"Location: %s\n"</span> % url
<span class="keyword">raise</span> <span class="py-builtins">SystemExit</span>
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">oreobounce - set a cookie and redirect the browser
</span><span class="keyword">import</span> Cookie
<span class="keyword">import</span> time

c = Cookie.SimpleCookie()
c[<span class="string">'filling'</span>] = <span class="string">'vanilla cr?me'</span>
now = time.time()
future = now + 3*(60*60*24*30) <span class="comment-delimiter"># </span><span class="comment">3 months
</span>expire_date = time.strftime(<span class="string">'%a %d %b %Y %H:%M:%S GMT'</span>, future)
c[<span class="string">'filling'</span>][<span class="string">'expires'</span>] = expire_date
c[<span class="string">'filling'</span>][<span class="string">'domain'</span>] = <span class="string">'.python.org'</span>

whither  = <span class="string">"http://somewhere.python.org/nonesuch.html"</span>

<span class="comment-delimiter"># </span><span class="comment">Prints the cookie header
</span><span class="keyword">print</span> <span class="string">'Status: 302 Moved Temporarily'</span>
<span class="keyword">print</span> c
<span class="keyword">print</span> <span class="string">'Location:'</span>, whither
<span class="keyword">print</span>

<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter">#</span><span class="comment">Status: 302 Moved Temporarily
</span><span class="comment-delimiter">#</span><span class="comment">Set-Cookie: filling=vanilla%20cr%E4me; domain=.perl.com;
</span><span class="comment-delimiter">#    </span><span class="comment">expires=Tue, 21-Jul-1998 11:58:55 GMT
</span><span class="comment-delimiter">#</span><span class="comment">Location: http://somewhere.perl.com/nonesuch.html
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">os_snipe - redirect to a Jargon File entry about current OS
</span><span class="keyword">import</span> os, re
<span class="py-builtins">dir</span> = <span class="string">'http://www.wins.uva.nl/%7Emes/jargon'</span>
matches = [
    (r<span class="string">'Mac'</span>, <span class="string">'m/Macintrash.html'</span>),
    (r<span class="string">'Win(dows )?NT'</span>, <span class="string">'e/evilandrude.html'</span>),
    (r<span class="string">'Win|MSIE|WebTV'</span>, <span class="string">'m/MicroslothWindows.html'</span>),
    (r<span class="string">'Linux'</span>, <span class="string">'l/Linux.html'</span>),
    (r<span class="string">'HP-UX'</span>, <span class="string">'h/HP-SUX.html'</span>),
    (r<span class="string">'SunOS'</span>, <span class="string">'s/ScumOS.html'</span>),
    (<span class="py-pseudo-keyword">None</span>, <span class="string">'a/AppendixB.html'</span>),
    ]

<span class="keyword">for</span> regex, page <span class="keyword">in</span> matches:
    <span class="keyword">if</span> <span class="keyword">not</span> regex: <span class="comment-delimiter"># </span><span class="comment">default
</span>        <span class="keyword">break</span>
    <span class="keyword">if</span> re.search(regex, os.environ[<span class="string">'HTTP_USER_AGENT'</span>]):
        <span class="keyword">break</span>
<span class="keyword">print</span> <span class="string">'Location: %s/%s\n'</span> % (dir, page)
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">There's no special way to print headers
</span><span class="keyword">print</span> <span class="string">'Status: 204 No response'</span>
<span class="keyword">print</span>
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter">#</span><span class="comment">Status: 204 No response
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment"><font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/dummyhttpd">download the following standalone program</a></font>
</span><span class="comment-delimiter">#</span><span class="comment">!/usr/bin/python
</span><span class="comment-delimiter"># </span><span class="comment">dummyhttpd - start a HTTP daemon and print what the client sends
</span>
<span class="keyword">import</span> SocketServer
<span class="comment-delimiter"># </span><span class="comment">or use BaseHTTPServer, SimpleHTTPServer, CGIHTTPServer
</span>
<span class="keyword">def</span> <span class="function-name">adr_str</span>(adr):
    <span class="keyword">return</span> <span class="string">"%s:%d"</span> % adr

<span class="keyword">class</span> <span class="type">RequestHandler</span>(SocketServer.BaseRequestHandler):
    <span class="keyword">def</span> <span class="function-name">handle</span>(<span class="py-pseudo-keyword">self</span>):
        <span class="keyword">print</span> <span class="string">"client access from %s"</span> % adr_str(<span class="py-pseudo-keyword">self</span>.client_address)
        <span class="keyword">print</span> <span class="py-pseudo-keyword">self</span>.request.recv(10000)
        <span class="py-pseudo-keyword">self</span>.request.send(<span class="string">"Content-Type: text/plain\n"</span>
                          <span class="string">"Server: dymmyhttpd/1.0.0\n"</span>
                          <span class="string">"\n...\n"</span>)
        <span class="py-pseudo-keyword">self</span>.request.close()


adr = (<span class="string">'127.0.0.1'</span>, 8001)
<span class="keyword">print</span> <span class="string">"Please contact me at &lt;<a href="http://%s">http://%s</a>&gt;"</span> % adr_str(adr)
server = SocketServer.TCPServer(adr, RequestHandler)
server.serve_forever()
server.server_close()</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span>
<span class="keyword">import</span> Cookie
cookies = Cookie.SimpleCookie()
<span class="comment-delimiter"># </span><span class="comment">SimpleCookie is more secure, but does not support all characters.
</span>cookies[<span class="string">"preference-name"</span>] = <span class="string">"whatever you'd like"</span> 
<span class="keyword">print</span> cookies

<span class="comment-delimiter"># </span><span class="comment"><font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/ic_cookies">download the following standalone program</a></font>
</span><span class="comment-delimiter">#</span><span class="comment">!/usr/bin/python
</span><span class="comment-delimiter"># </span><span class="comment">ic_cookies - sample CGI script that uses a cookie
</span>
<span class="keyword">import</span> cgi
<span class="keyword">import</span> os
<span class="keyword">import</span> Cookie
<span class="keyword">import</span> datetime

cookname = <span class="string">"favorite-ice-cream"</span>  <span class="comment-delimiter"># </span><span class="comment">SimpleCookie does not support blanks
</span>fieldname = <span class="string">"flavor"</span>

cookies = Cookie.SimpleCookie(os.environ.get(<span class="string">"HTTP_COOKIE"</span>,<span class="string">""</span>))
<span class="keyword">if</span> cookies.has_key(cookname):
    favorite = cookies[cookname].value
<span class="keyword">else:</span>
    favorite = <span class="string">"mint"</span>

form = cgi.FieldStorage()
<span class="keyword">if</span> <span class="keyword">not</span> form.has_key(fieldname):
    <span class="keyword">print</span> <span class="string">"Content-Type: text/html"</span>
    <span class="keyword">print</span> <span class="string">"\n"</span>
    <span class="keyword">print</span> <span class="string">"&lt;html&gt;&lt;body&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;h1&gt;Hello Ice Cream&lt;/h1&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;form&gt;"</span>
    <span class="keyword">print</span> <span class="string">'Please select a flavor: &lt;input type="text" name="%s" value="%s" /&gt;'</span> % (
            fieldname, favorite )
    <span class="keyword">print</span> <span class="string">"&lt;/form&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;hr /&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;/body&gt;&lt;/html&gt;"</span>
<span class="keyword">else:</span>
    favorite = form[fieldname].value
    cookies[cookname] = favorite
    expire = datetime.datetime.now() + datetime.timedelta(730)
    cookies[cookname][<span class="string">"expires"</span>] = expire.strftime(<span class="string">"%a, %d %b %Y %H:00:00 GMT"</span>)
    cookies[cookname][<span class="string">"path"</span>] = <span class="string">"/"</span>
    <span class="keyword">print</span> <span class="string">"Content-Type: text/html"</span>
    <span class="keyword">print</span> cookies
    <span class="keyword">print</span> <span class="string">"\n"</span>
    <span class="keyword">print</span> <span class="string">"&lt;html&gt;&lt;body&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;h1&gt;Hello Ice Cream&lt;/h1&gt;"</span>
    <span class="keyword">print</span> <span class="string">"&lt;p&gt;You chose as your favorite flavor \"%s\"&lt;/p&gt;"</span> % favorite
    <span class="keyword">print</span> <span class="string">"&lt;/body&gt;&lt;/html&gt;"</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">first open and exclusively lock the file
</span><span class="keyword">import</span> os, cgi, fcntl, cPickle
fh = <span class="py-builtins">open</span>(<span class="string">'/tmp/formlog'</span>, <span class="string">'ab'</span>)
fcntl.flock(fh.fileno(), fcntl.LOCK_EX)

form = cgi.FieldStorage()
<span class="comment-delimiter"># </span><span class="comment">This doesn't produce a readable file; we copy the environment so
</span><span class="comment-delimiter"># </span><span class="comment">that we save a plain dictionary (os.environ is a dictionary-like
</span><span class="comment-delimiter"># </span><span class="comment">object).
</span>cPickle.dump((form, os.environ.copy()) fh)
fh.close()
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="keyword">import</span> cgi, smtplib, sys

form = cgi.FieldStorage()
email = <span class="string">"""\
From: %S
To: hisname@hishost.com
Subject: mailed form submission

"""</span> % sys.argv[0]

<span class="keyword">for</span> key <span class="keyword">in</span> form:
    values = form[key]
    <span class="keyword">if</span> <span class="keyword">not</span> <span class="py-builtins">isinstance</span>(values, list):
        value = [values.value]
    <span class="keyword">else:</span>
        value = [v.value <span class="keyword">for</span> v <span class="keyword">in</span> values]
    <span class="keyword">for</span> item <span class="keyword">in</span> values:
        email += <span class="string">'\n%s: %s'</span> % (key, value)

server = smtplib.SMTP(<span class="string">'localhost'</span>)
server.sendmail(sys.argv[0], [<span class="string">'hisname@hishost.com'</span>], email)
server.quit()
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@ I don't get the point of these:
</span><span class="comment-delimiter"># </span><span class="comment">param("_timestamp", scalar localtime);
</span><span class="comment-delimiter"># </span><span class="comment">param("_environs", %ENV);
</span><span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span><span class="keyword">import</span> fcntl, cPickle
fh = <span class="py-builtins">open</span>(<span class="string">'/tmp/formlog'</span>, <span class="string">'rb'</span>)
fcntl.flock(fh.fileno(), fcntl.LOCK_SH)

count = 0
<span class="keyword">while</span> <span class="py-pseudo-keyword">True</span>:
    <span class="keyword">try:</span>
        form, environ = cPickle.load(fh)
    <span class="keyword">except</span> <span class="py-builtins">EOFError</span>:
        <span class="keyword">break</span>
    <span class="keyword">if</span> environ.get(<span class="string">'REMOTE_HOST'</span>).endswith(<span class="string">'perl.com'</span>):
        <span class="keyword">continue</span>
    <span class="keyword">if</span> <span class="string">'items requested'</span> <span class="keyword">in</span> form:
        count += <span class="py-builtins">int</span>(form[<span class="string">'items requested'</span>].value)
<span class="keyword">print</span> <span class="string">'Total orders:'</span>, count
<span class="comment-delimiter">#</span><span class="comment">-----------------------------
</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span><span class="comment-delimiter"># </span><span class="comment">@@INCOMPLETE@@
</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>